<!DOCTYPE html>
<html>
<head>
    <title>Custom Blink</title>
    <meta description="Make your own blinking sequence.">
    <meta publisher="Jose Miranda (Conversion and improvements)">

    <meta property="speed" label="Animation Speed" type="number" min="1" max="50" default="10">
    <meta property="interval" label="Step Interval" type="number" min="1" max="100" default="10">
    <meta property="random_colors" label="Random Colors" type="boolean" default="false">
    <meta property="color1" label="Color 1" type="color" default="#ff0000">
    <meta property="color2" label="Color 2" type="color" default="#00ff00">
    <meta property="color3" label="Color 3" type="color" default="#0000ff">
    <meta property="color4" label="Color 4" type="color" default="#ffff00">

    <meta property="pattern_step_1" label="Step 1" type="list" values="Off,Blink 1,Blink 2,Marquee 1,Marquee 2,Marquee 3,Marquee 4,Breath 1,Breath 2,Breath 3,Breath 4,Breath 5,Moving Band 1,Moving Band 2,Moving Band 3,Moving Band 4,Flash 1,Flash 2,Flash 3,Flash 4,Alternate 1,Alternate 2" default="Moving Band 1">
    <meta property="pattern_step_2" label="Step 2" type="list" values="Off,Blink 1,Blink 2,Marquee 1,Marquee 2,Marquee 3,Marquee 4,Breath 1,Breath 2,Breath 3,Breath 4,Breath 5,Moving Band 1,Moving Band 2,Moving Band 3,Moving Band 4,Flash 1,Flash 2,Flash 3,Flash 4,Alternate 1,Alternate 2" default="Moving Band 2">
    <meta property="pattern_step_3" label="Step 3" type="list" values="Off,Blink 1,Blink 2,Marquee 1,Marquee 2,Marquee 3,Marquee 4,Breath 1,Breath 2,Breath 3,Breath 4,Breath 5,Moving Band 1,Moving Band 2,Moving Band 3,Moving Band 4,Flash 1,Flash 2,Flash 3,Flash 4,Alternate 1,Alternate 2" default="Off">
    <meta property="pattern_step_4" label="Step 4" type="list" values="Off,Blink 1,Blink 2,Marquee 1,Marquee 2,Marquee 3,Marquee 4,Breath 1,Breath 2,Breath 3,Breath 4,Breath 5,Moving Band 1,Moving Band 2,Moving Band 3,Moving Band 4,Flash 1,Flash 2,Flash 3,Flash 4,Alternate 1,Alternate 2" default="Off">
    <meta property="pattern_step_5" label="Step 5" type="list" values="Off,Blink 1,Blink 2,Marquee 1,Marquee 2,Marquee 3,Marquee 4,Breath 1,Breath 2,Breath 3,Breath 4,Breath 5,Moving Band 1,Moving Band 2,Moving Band 3,Moving Band 4,Flash 1,Flash 2,Flash 3,Flash 4,Alternate 1,Alternate 2" default="Off">
    <meta property="pattern_step_6" label="Step 6" type="list" values="Off,Blink 1,Blink 2,Marquee 1,Marquee 2,Marquee 3,Marquee 4,Breath 1,Breath 2,Breath 3,Breath 4,Breath 5,Moving Band 1,Moving Band 2,Moving Band 3,Moving Band 4,Flash 1,Flash 2,Flash 3,Flash 4,Alternate 1,Alternate 2" default="Off">
    <meta property="pattern_step_7" label="Step 7" type="list" values="Off,Blink 1,Blink 2,Marquee 1,Marquee 2,Marquee 3,Marquee 4,Breath 1,Breath 2,Breath 3,Breath 4,Breath 5,Moving Band 1,Moving Band 2,Moving Band 3,Moving Band 4,Flash 1,Flash 2,Flash 3,Flash 4,Alternate 1,Alternate 2" default="Off">
    <meta property="pattern_step_8" label="Step 8" type="list" values="Off,Blink 1,Blink 2,Marquee 1,Marquee 2,Marquee 3,Marquee 4,Breath 1,Breath 2,Breath 3,Breath 4,Breath 5,Moving Band 1,Moving Band 2,Moving Band 3,Moving Band 4,Flash 1,Flash 2,Flash 3,Flash 4,Alternate 1,Alternate 2" default="Off">
</head>

<body style="margin: 0; padding: 0;">
    <canvas id="customblink-canvas" width="320" height="200"></canvas>
</body>

<script>
// -------------------------------------------------------------------
// SETUP
// -------------------------------------------------------------------

const canvas = document.getElementById('customblink-canvas');
const ctx = canvas.getContext('2d');
const canvasWidth = canvas.width;
const canvasHeight = canvas.height;

// Effect state variables
let time = 0.0;
let colors = [[255,0,0], [0,255,0], [0,0,255], [255,255,0]];
let activePattern = "Off";
let lastStep = -1;

// -------------------------------------------------------------------
// COLOR UTILITIES
// -------------------------------------------------------------------

function hexToRgb(hex) {
    if (!hex) return [0, 0, 0];
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return [r, g, b];
}

function applyBrightness(rgb, brightness) {
    return [rgb[0] * brightness, rgb[1] * brightness, rgb[2] * brightness];
}

// -------------------------------------------------------------------
// PATTERN DEFINITIONS
// -------------------------------------------------------------------

const patterns = {
    "Off": (x, w, t) => [0,0,0],
    "Blink 1": (x, w, t) => {
        if (x % 2 === 0) return [0,0,0];
        if ((x + 1) % 4 === 0) return t.even ? colors[0] : colors[1];
        return t.even ? colors[1] : colors[0];
    },
    "Blink 2": (x, w, t) => {
        if (x % 2 === 0) return [0,0,0];
        if ((x + 1) % 4 === 0) return t.even ? colors[2] : colors[3];
        return t.even ? colors[3] : colors[2];
    },
    "Marquee 1": (x, w, t) => {
        if (Math.floor(t.time + x) % 2 === 0) return [0,0,0];
        if (Math.floor(t.time + x + 1) % 4 === 0) return t.even ? colors[0] : colors[1];
        return t.even ? colors[1] : colors[0];
    },
    "Marquee 2": (x, w, t) => {
        if (Math.floor(-t.time + x) % 2 === 0) return [0,0,0];
        if (Math.floor(-t.time + x + 1) % 4 === 0) return t.even ? colors[2] : colors[3];
        return t.even ? colors[3] : colors[2];
    },
    "Marquee 3": (x, w, t) => {
        if (Math.floor(2 * t.time + x) % 2 === 0) return [0,0,0];
        if (Math.floor(2 * t.time + x + 1) % 4 === 0) return t.even ? colors[0] : colors[1];
        return t.even ? colors[1] : colors[0];
    },
    "Marquee 4": (x, w, t) => {
        if (Math.floor(-2 * t.time + x) % 2 === 0) return [0,0,0];
        if (Math.floor(-2 * t.time + x + 1) % 4 === 0) return t.even ? colors[2] : colors[3];
        return t.even ? colors[3] : colors[2];
    },
    "Breath 1": (x, w, t) => {
        if (x % 2 === 0) return [0,0,0];
        if ((x + 1) % 4 === 0) return applyBrightness(colors[0], t.s1);
        return applyBrightness(colors[1], t.s2);
    },
    "Breath 2": (x, w, t) => {
        if (Math.floor(t.time + x) % 2 === 0) return [0,0,0];
        if (Math.floor(t.time + x + 1) % 4 === 0) return applyBrightness(colors[0], t.s1);
        return applyBrightness(colors[1], t.s2);
    },
    "Breath 3": (x, w, t) => {
        if (x % 2 === 0) return [0,0,0];
        if ((x + 1) % 4 === 0) return applyBrightness(colors[2], t.s1);
        return applyBrightness(colors[3], t.s2);
    },
    "Breath 4": (x, w, t) => {
        if (Math.floor(-t.time + x) % 2 === 0) return [0,0,0];
        if (Math.floor(-t.time + x + 1) % 4 === 0) return applyBrightness(colors[2], t.s1);
        return applyBrightness(colors[3], t.s2);
    },
    "Breath 5": (x, w, t) => {
        const s = x % 2 === 0 ? t.s1 : 1 - t.s1;
        return applyBrightness(colors[x % 4], s);
    },
    "Moving Band 1": (x, w, t) => colors[Math.floor(t.time + x) % 4],
    "Moving Band 2": (x, w, t) => colors[Math.abs(Math.floor(-t.time + x) % 4)],
    "Moving Band 3": (x, w, t) => colors[Math.floor(2 * t.time + x) % 4],
    "Moving Band 4": (x, w, t) => colors[Math.abs(Math.floor(-2 * t.time + x) % 4)],
    "Flash 1": (x, w, t) => (t.s2 > 0.5) ? colors[x % 4] : [0,0,0],
    "Flash 2": (x, w, t) => (t.s4 > 0.5) ? colors[x % 4] : [0,0,0],
    "Flash 3": (x, w, t) => (t.s8 > 0.5) ? colors[x % 4] : [0,0,0],
    "Flash 4": (x, w, t) => (t.s16 > 0.5) ? colors[x % 4] : [0,0,0],
    "Alternate 1": (x, w, t) => (x >= w / 2) ? (t.even ? colors[0] : colors[1]) : (t.even ? colors[1] : colors[0]),
    "Alternate 2": (x, w, t) => (x >= w / 2) ? (t.even ? colors[2] : colors[3]) : (t.even ? colors[3] : colors[2]),
};

// -------------------------------------------------------------------
// MAIN ANIMATION LOOP
// -------------------------------------------------------------------

let lastTime = 0;
function update(currentTime) {
    const deltaTime = (currentTime - lastTime) / 1000;
    lastTime = currentTime;

    if (isNaN(deltaTime)) {
        requestAnimationFrame(update);
        return;
    }

    // Update time and pre-calculate sine values
    time += 0.1 * speed * deltaTime;
    const time_int = Math.floor(time);
    const timeValues = {
        time: time,
        even: time_int % 2 === 0,
        s1: 0.5 + 0.5 * Math.sin(time),
        s2: 0.5 + 0.5 * Math.sin(2 * time),
        s4: 0.5 + 0.5 * Math.sin(4 * time),
        s8: 0.5 + 0.5 * Math.sin(8 * time),
        s16: 0.5 + 0.5 * Math.sin(16 * time),
    };

    // Determine which step in the sequence is active
    const sequence = [
        pattern_step_1, pattern_step_2, pattern_step_3, pattern_step_4,
        pattern_step_5, pattern_step_6, pattern_step_7, pattern_step_8,
    ].filter(p => p && p !== "Off");

    if (sequence.length === 0) {
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        requestAnimationFrame(update);
        return;
    }

    const currentStep = Math.floor(time_int / interval) % sequence.length;
    activePattern = sequence[currentStep];
    
    // When the step changes, update the colors
    if(currentStep !== lastStep) {
        if (random_colors) {
            colors = [randomRgb(), randomRgb(), randomRgb(), randomRgb()];
        } else {
            colors = [hexToRgb(color1), hexToRgb(color2), hexToRgb(color3), hexToRgb(color4)];
        }
        lastStep = currentStep;
    }
    
    const patternFunc = patterns[activePattern] || patterns["Off"];

    // Render
    for (let x = 0; x < canvasWidth; x++) {
        const rgb = patternFunc(x, canvasWidth, timeValues);
        ctx.fillStyle = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
        ctx.fillRect(x, 0, 1, canvasHeight);
    }
    
    requestAnimationFrame(update);
}

// Initial call
requestAnimationFrame(update);

</script>
</html>