<!DOCTYPE html>
<html>
<head>
    <title>Sequence</title>
    <meta description="Alternates colors with a fade effect.">
    <meta publisher="Jose Miranda (Conversion and improvements)">

    <meta property="speed" label="Speed" type="number" min="1" max="20" default="10">
    <meta property="fade_time" label="Fade Time" type="number" min="1" max="100" default="50">
    
    <meta property="color1" label="Color 1" type="color" default="#ff0000">
    <meta property="color2" label="Color 2" type="color" default="#00ff00">
    <meta property="color3" label="Color 3" type="color" default="#0000ff">
    <meta property="color4" label="Color 4" type="color" default="#ffff00">
    <meta property="color5" label="Color 5" type="color" default="#000000">
    <meta property="color6" label="Color 6" type="color" default="#000000">
    <meta property="color7" label="Color 7" type="color" default="#000000">
    <meta property="color8" label="Color 8" type="color" default="#000000">
</head>

<body style="margin: 0; padding: 0;">
    <canvas id="sequence-canvas" width="320" height="200"></canvas>
</body>

<script>
// -------------------------------------------------------------------
// SETUP
// -------------------------------------------------------------------

const canvas = document.getElementById('sequence-canvas');
const ctx = canvas.getContext('2d');

// Effect state variables
let progress = 0.0;

// -------------------------------------------------------------------
// COLOR UTILITIES
// -------------------------------------------------------------------

function hexToRgb(hex) {
    if (!hex) return [0, 0, 0];
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return [r, g, b];
}

/** Linearly interpolates between two colors */
function lerpColor(c1, c2, factor) {
    const r = c1[0] * (1 - factor) + c2[0] * factor;
    const g = c1[1] * (1 - factor) + c2[1] * factor;
    const b = c1[2] * (1 - factor) + c2[2] * factor;
    return [r, g, b];
}

// -------------------------------------------------------------------
// MAIN ANIMATION LOOP
// -------------------------------------------------------------------

let lastTime = 0;
function update(currentTime) {
    const deltaTime = (currentTime - lastTime) / 1000;
    lastTime = currentTime;

    if (isNaN(deltaTime)) {
        requestAnimationFrame(update);
        return;
    }

    // --- Update State ---

    // Collect user colors, filtering out black/empty ones
    const colors = [color1, color2, color3, color4, color5, color6, color7, color8]
        .filter(c => c && c !== "#000000")
        .map(hexToRgb);
    
    if (colors.length === 0) {
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        requestAnimationFrame(update);
        return;
    }
    
    const color_count = colors.length;
    const current_color_index = Math.floor(progress) % color_count;
    const frac = progress % 1.0;

    let final_color;
    let fade_mult = 1.0;

    // The last 20% of the cycle is the fade period (frac >= 0.8)
    if (frac >= 0.8) {
       const next_color_index = (current_color_index + 1) % color_count;
       const fade_progress = (frac - 0.8) * 5; // Scale 0.8-1.0 range to 0.0-1.0
       final_color = lerpColor(colors[current_color_index], colors[next_color_index], fade_progress);
       // The fade speed is controlled by the slider
       fade_mult = 1.0 / (fade_time/10);
    } else {
        // Hold the current color
        final_color = colors[current_color_index];
    }
    
    // Increment progress for the next frame
    progress += fade_mult * 0.1 * speed * deltaTime;

    // --- Render ---
    ctx.fillStyle = `rgb(${final_color[0]}, ${final_color[1]}, ${final_color[2]})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    requestAnimationFrame(update);
}

// Initial call
requestAnimationFrame(update);

</script>
</html>